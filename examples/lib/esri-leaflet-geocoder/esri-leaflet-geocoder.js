/*! esri-leaflet-geocoder - v0.0.1 - 2013-11-04
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(a){function b(a,b){b=b||window;for(var c,d=b,e=a.split(".");c=e.shift();)d[c]||(d[c]={}),d=d[c];return d}function c(a){var b="?";for(var c in a)if(a.hasOwnProperty(c)){var d=c,e=a[c];b+=encodeURIComponent(d),b+="=",b+=encodeURIComponent(e),b+="&"}return b.substring(0,b.length-1)}function d(b){var c=new a.LatLng(b.ymin,b.xmin),d=new a.LatLng(b.ymax,b.xmax);return new a.LatLngBounds(c,d)}b("L.esri.Services.Geocoding"),b("L.esri.Controls.Geosearch"),a.esri.Services.Geocoding=a.Class.extend({includes:a.Mixin.Events,options:{url:"https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/",outFields:"Subregion, Region, PlaceName, Match_addr, Country, Addr_type, City"},initialize:function(b){a.Util.setOptions(this,b)},request:function(b,d,e){var f="c"+(1e9*Math.random()).toString(36).replace(".","_");d.f="json",d.callback="L.esri.Services.Geocoding._callback."+f;var g=document.createElement("script");g.type="text/javascript",g.src=b+c(d),g.id=f,this.fire("loading"),a.esri.Services.Geocoding._callback[f]=a.Util.bind(function(b){this.fire("load"),e(b),document.body.removeChild(g),delete a.esri.Services.Geocoding._callback[f]},this),document.body.appendChild(g)},geocode:function(b,c,d){var e={outFields:this.options.outFields},f=a.extend(e,c);f.text=b,this.request(this.options.url+"find",f,d)},suggest:function(a,b,c){var d=b||{};d.text=a,this.request(this.options.url+"suggest",d,c)}}),a.esri.Services.geocoding=function(b){return new a.esri.Services.Geocoding(b)},a.esri.Services.Geocoding._callback={},a.esri.Controls.Geosearch=a.Control.extend({includes:a.Mixin.Events,options:{position:"topleft",zoomToResult:!0,useMapBounds:11,collapseAfterResult:!0,expanded:!1,containerClass:"geocoder-control",inputClass:"geocoder-control-input leaflet-bar",suggestionsWrapperClass:"geocoder-control-suggestions leaflet-bar",selectedSuggestionClass:"geocoder-control-selected",expandedClass:"geocoder-control-expanded"},initialize:function(b){a.Util.setOptions(this,b),this._service=new a.esri.Services.Geocoding},_geocode:function(b,c){var e={};c&&(e.magicKey=c),a.DomUtil.addClass(this._input,"loading"),this.fire("loading"),this._service.geocode(b,e,a.Util.bind(function(c){a.DomUtil.removeClass(this._input,"loading");var e=c.locations[0],f=e.feature.attributes,g=d(e.extent);this.options.zoomToResult&&this._map.fitBounds(g),this.fire("load"),this.fire("result",{text:b,bounds:g,latlng:new a.LatLng(e.feature.geometry.y,e.feature.geometry.x),name:f.PlaceName,match:f.Addr_type,country:f.Country,region:f.Region,subregion:f.Subregion,city:f.City,address:f.Match_addr}),this.clear()},this))},_suggest:function(b){a.DomUtil.addClass(this._input,"loading");var c={};if(this.options.useMapBounds===!0||this._map.getZoom()>=this.options.useMapBounds){var d=this._map.getBounds(),e=d.getCenter(),f=d.getNorthWest();c.location=e.lng+","+e.lat,c.distance=Math.min(Math.max(e.distanceTo(f),2e3),5e4)}this._service.suggest(b,c,a.Util.bind(function(b){if(this._input.value){if(this._suggestions.innerHTML="",b.suggestions)for(var c=0;c<b.suggestions.length;c++){var d=a.DomUtil.create("li","geocoder-control-suggestion",this._suggestions);d.innerHTML=b.suggestions[c].text,d["data-magic-key"]=b.suggestions[c].magicKey}a.DomUtil.removeClass(this._input,"loading")}},this))},clear:function(){this._suggestions.innerHTML="",this._input.value="",this.options.collapseAfterResult&&a.DomUtil.removeClass(this._container,this.options.expandedClass),this._input.blur()},onAdd:function(b){return this._map=b,this._container=a.DomUtil.create("div",this.options.containerClass+(this.options.expanded?" "+this.options.expandedClass:"")),this._input=a.DomUtil.create("input",this.options.inputClass,this._container),this._suggestions=a.DomUtil.create("ul",this.options.suggestionsWrapperClass,this._container),a.DomEvent.addListener(this._container,"click",function(){a.DomUtil.addClass(this._container,this.options.expandedClass)},this),a.DomEvent.addListener(this._suggestions,"mousedown",function(a){this._geocode(a.target.innerHTML,a.target["data-magic-key"]),this.clear()},this),a.DomEvent.addListener(this._input,"blur",function(){this.clear()},this),a.DomEvent.addListener(this._input,"keydown",function(b){var c=this._suggestions.getElementsByClassName(this.options.selectedSuggestionClass)[0];switch(b.keyCode){case 13:c?(this._geocode(c.innerHTML,c["data-magic-key"]),this.clear()):a.DomUtil.addClass(this._suggestions.childNodes[0],this.options.selectedSuggestionClass),a.DomEvent.preventDefault(b);break;case 38:c&&a.DomUtil.removeClass(c,this.options.selectedSuggestionClass),c&&c.previousSibling?a.DomUtil.addClass(c.previousSibling,this.options.selectedSuggestionClass):a.DomUtil.addClass(this._suggestions.childNodes[this._suggestions.childNodes.length-1],this.options.selectedSuggestionClass),a.DomEvent.preventDefault(b);break;case 40:c&&a.DomUtil.removeClass(c,this.options.selectedSuggestionClass),c&&c.nextSibling?a.DomUtil.addClass(c.nextSibling,this.options.selectedSuggestionClass):a.DomUtil.addClass(this._suggestions.childNodes[0],this.options.selectedSuggestionClass),a.DomEvent.preventDefault(b)}},this),a.DomEvent.addListener(this._input,"keyup",function(a){13!==a.keyCode&&38!==a.keyCode&&40!==a.keyCode&&this._suggest(a.target.value)},this),this._container}}),a.esri.Controls.geosearch=function(b){return new a.esri.Controls.Geosearch(b)}}(L);