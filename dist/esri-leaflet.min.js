/*! Esri-Leaflet - v0.0.1 - 2013-07-02
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(b),"object"==typeof window&&(a.Terraformer=b())}(this,function(){function a(){this._thens=[]}function b(){var a=Array.prototype.slice.apply(arguments);void 0!==typeof console&&console.warn&&console.warn.apply(console,a)}function c(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function d(a){switch(a.type){case"Point":return[a.coordinates[0],a.coordinates[1],a.coordinates[0],a.coordinates[1]];case"MultiPoint":return g(a.coordinates);case"LineString":return g(a.coordinates);case"MultiLineString":return e(a.coordinates);case"Polygon":return e(a.coordinates);case"MultiPolygon":return f(a.coordinates);case"Feature":return d(a.geometry);case"FeatureCollection":return h(a);case"GeometryCollection":return i(a);default:throw new Error("Unknown type: "+a.type)}}function e(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++){var i=g[h],j=i[0],k=i[1];null===b?b=j:b>j&&(b=j),null===c?c=j:j>c&&(c=j),null===d?d=k:d>k&&(d=k),null===e?e=k:k>e&&(e=k)}return[b,d,c,e]}function f(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++)for(var g=a[f],h=0;h<g.length;h++)for(var i=g[h],j=0;j<i.length;j++){var k=i[j],l=k[0],m=k[1];null===b?b=l:b>l&&(b=l),null===c?c=l:l>c&&(c=l),null===d?d=m:d>m&&(d=m),null===e?e=m:m>e&&(e=m)}return[b,d,c,e]}function g(a){for(var b=null,c=null,d=null,e=null,f=0;f<a.length;f++){var g=a[f],h=g[0],i=g[1];null===b?b=h:b>h&&(b=h),null===c?c=h:h>c&&(c=h),null===d?d=i:d>i&&(d=i),null===e?e=i:i>e&&(e=i)}return[b,d,c,e]}function h(a){for(var b,c=[],e=a.features.length-1;e>=0;e--)b=d(a.features[e].geometry),c.push([b[0],b[1]]),c.push([b[2],b[3]]);return g(c)}function i(a){for(var b,c=[],e=a.geometries.length-1;e>=0;e--)b=d(a.geometries[e]),c.push([b[0],b[1]]),c.push([b[2],b[3]]);return g(c)}function j(a){var b=d(a);return{x:b[0],y:b[1],w:Math.abs(b[0]-b[2]),h:Math.abs(b[1]-b[3])}}function k(a){return a*W}function l(a){return a*X}function m(a,b){for(var c=0;c<a.length;c++)"number"==typeof a[c][0]&&(a[c]=b(a[c])),"object"==typeof a[c]&&(a[c]=m(a[c],b));return a}function n(a){var b=a[0],c=a[1];return[k(b/V)-360*Math.floor((k(b/V)+180)/360),k(Math.PI/2-2*Math.atan(Math.exp(-1*c/V)))]}function o(a){var b=a[0],c=Math.max(Math.min(a[1],89.99999),-89.99999);return[l(b)*V,V/2*Math.log((1+Math.sin(l(c)))/(1-Math.sin(l(c))))]}function p(a,b,c){if("Point"===a.type)a.coordinates=b(a.coordinates);else if("Feature"===a.type)a.geometry=p(a.geometry,b,!0);else if("FeatureCollection"===a.type)for(var d=0;d<a.features.length;d++)a.features[d]=p(a.features[d],b,!0);else if("GeometryCollection"===a.type)for(var e=0;e<a.geometries.length;e++)a.geometries[e]=p(a.geometries[e],b,!0);else a.coordinates=m(a.coordinates,b);return c||b===o&&(a.crs=Y),b===n&&delete a.crs,a}function q(a){return p(a,o)}function r(a){return p(a,n)}function s(a,b){return b>a?-1:a>b?1:0}function t(a,b,c){return s((b[0]-a[0])*(c[1]-a[1])-(c[0]-a[0])*(b[1]-a[1]),0)}function u(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d}function v(a,b){var c=b;for(var d in a){var e=t(b,c,a[d]);(-1===e||0===e&&u(b,a[d])>u(b,c))&&(c=a[d])}return c}function w(a){function b(a,b){return a[0]-b[0]>a[1]-b[1]?1:a[0]-b[0]<a[1]-b[1]?-1:0}if(0===a.length)return[];if(1===a.length)return a;for(var c=[a.sort(b)[0]],d=0;d<c.length;d++){var e=v(a,c[d]);e!==c[0]&&c.push(e)}return c}function x(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!0);return c}function y(a,b){if(a&&a.length){if(1===a.length)return x(a[0],b);if(x(a[0],b)){for(var c=1;c<a.length;c++)if(x(a[c],b))return!1;return!0}return!1}return!1}function z(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function A(a,b){for(var c=0;c<a.length-1;c++)for(var d=0;d<b.length-1;d++)if(z(a[c],a[c+1],b[d],b[d+1]))return!0;return!1}function B(a,b){for(var c=0;c<b.length;c++)for(var d=b[c],e=0;e<d.length-1;e++)for(var f=0;f<a.length-1;f++)if(z(d[e],d[e+1],a[f],a[f+1]))return!0;return!1}function C(a,b){for(var c=0;c<a.length;c++)if(B(a[c],b))return!0;return!1}function D(a,b){for(var c=0;c<b.length;c++)return B(a,b[c])?!0:!1}function E(a,b){for(var c=0;c<a.length;c++)return D(a[c],b)?!0:!1}function F(a,b){for(var c=0;c<a.length;c++)return E(a[c],b)?!0:!1}function G(a){for(var b=[],c=0;c<a.length;c++){var d=a[c].slice();H(d[0],d[d.length-1])===!1&&d.push(d[0]),b.push(d)}return b}function H(a,b){for(var c=0;c<a.length;c++)for(var d=0;d<b.length;d++)if(a[c]!==b[d])return!1;return!0}function I(a){if(a)switch(a.type){case"Point":return new J(a);case"MultiPoint":return new K(a);case"LineString":return new L(a);case"MultiLineString":return new M(a);case"Polygon":return new N(a);case"MultiPolygon":return new O(a);case"Feature":return new P(a);case"FeatureCollection":return new Q(a);case"GeometryCollection":return new R(a);default:throw new Error("Unknown type: "+a.type)}}function J(a){var b=Array.prototype.slice.call(arguments);if(a&&"Point"===a.type&&a.coordinates)c(this,a);else if(a&&Array.isArray(a))this.coordinates=a;else{if(!(b.length>=2))throw"Terraformer: invalid input for Terraformer.Point";this.coordinates=b}this.type="Point",this.__defineGetter__("bbox",function(){return d(this)})}function K(a){if(a&&"MultiPoint"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiPoint";this.coordinates=a}this.type="MultiPoint",this.__defineGetter__("bbox",function(){return d(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function L(a){if(a&&"LineString"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.LineString";this.coordinates=a}this.type="LineString",this.__defineGetter__("bbox",function(){return d(this)})}function M(a){if(a&&"MultiLineString"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiLineString";this.coordinates=a}this.type="MultiLineString",this.__defineGetter__("bbox",function(){return d(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function N(a){if(a&&"Polygon"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.Polygon";this.coordinates=a}this.type="Polygon",this.__defineGetter__("bbox",function(){return d(this)})}function O(a){if(a&&"MultiPolygon"===a.type&&a.coordinates)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.MultiPolygon";this.coordinates=a}this.type="MultiPolygon",this.__defineGetter__("bbox",function(){return d(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function P(a){if(a&&"Feature"===a.type&&a.geometry)c(this,a);else{if(!(a&&a.type&&a.coordinates))throw"Terraformer: invalid input for Terraformer.Feature";this.geometry=a}this.type="Feature",this.__defineGetter__("bbox",function(){return d(this)})}function Q(a){if(a&&"FeatureCollection"===a.type&&a.features)c(this,a);else{if(!Array.isArray(a))throw"Terraformer: invalid input for Terraformer.FeatureCollection";this.features=a}this.type="FeatureCollection",this.__defineGetter__("length",function(){return this.features?this.features.length:0}),this.__defineGetter__("bbox",function(){return d(this)})}function R(a){if(a&&"GeometryCollection"===a.type&&a.geometries)c(this,a);else if(Array.isArray(a))this.geometries=a;else{if(!a.coordinates||!a.type)throw"Terraformer: invalid input for Terraformer.GeometryCollection";this.type="GeometryCollection",this.geometries=[a]}this.type="GeometryCollection",this.__defineGetter__("length",function(){return this.geometries?this.geometries.length:0}),this.__defineGetter__("bbox",function(){return d(this)})}function S(a,b,c){for(var d=o(a),e=c||64,f=b||250,g={type:"Polygon",coordinates:[[]]},h=1;e>=h;h++){var i=h*(360/e)*Math.PI/180;g.coordinates[0].push([d[0]+f*Math.cos(i),d[1]+f*Math.sin(i)])}return r(g)}function T(a,b,e){var f=e||64,g=b||250;if(!a||a.length<2||!g||!f)throw new Error("Terraformer: missing parameter for Terraformer.Circle");c(this,new P({type:"Feature",geometry:S(a,g,f),properties:{radius:g,center:a,steps:f}})),this.__defineGetter__("bbox",function(){return d(this)}),this.__defineGetter__("radius",function(){return this.properties.radius}),this.__defineSetter__("radius",function(a){this.properties.radius=a,this.recalculate()}),this.__defineGetter__("steps",function(){return this.properties.steps}),this.__defineSetter__("steps",function(a){this.properties.steps=a,this.recalculate()}),this.__defineGetter__("center",function(){return this.properties.center}),this.__defineSetter__("center",function(a){this.properties.center=a,this.recalculate()})}var U={},V=6378137,W=57.29577951308232,X=.017453292519943,Y={type:"link",properties:{href:"http://spatialreference.org/ref/sr-org/6928/ogcwkt/",type:"ogcwkt"}},Z={type:"link",properties:{href:"http://spatialreference.org/ref/epsg/4326/ogcwkt/",type:"ogcwkt"}};a.prototype={then:function(a,b){return this._thens.push({resolve:a,reject:b}),this},resolve:function(a){return this._complete("resolve",a),this},reject:function(a){return this._complete("reject",a),this},_complete:function(a,b){this.then="resolve"===a?function(a){a(b)}:function(a,c){c(b)},this.resolve=this.reject=function(){throw new Error("Deferred already completed.")};for(var c=0;c<this._thens.length;c++){var d=this._thens[c];d[a]&&d[a](b)}delete this._thens}};var $=["length","bbox"];return I.prototype={toMercator:function(){return q(this)},toGeographic:function(){return r(this)},envelope:function(){var a=d(this);return{x:a[0],y:a[1],w:Math.abs(a[0]-a[2]),h:Math.abs(a[1]-a[3])}},convexHull:function(){var a,b,c=[];if("Point"===this.type)return this.coordinates&&this.coordinates.length>0?[this.coordinates]:[];if("LineString"===this.type||"MultiPoint"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[];c=this.coordinates}else if("Polygon"===this.type||"MultiLineString"===this.type){if(!(this.coordinates&&this.coordinates.length>0))return[];for(a=0;a<this.coordinates.length;a++)c=c.concat(this.coordinates[a])}else{if("MultiPolygon"!==this.type)throw new Error("Unable to get convex hull of "+this.type);if(!(this.coordinates&&this.coordinates.length>0))return[];for(a=0;a<this.coordinates.length;a++)for(b=0;b<this.coordinates[a].length;b++)c=c.concat(this.coordinates[a][b])}return w(c)},toJSON:function(){var a={};for(var b in this)this.hasOwnProperty(b)&&this[b]&&$.indexOf(b)&&(a[b]=this[b]);return a.bbox=d(this),a},toJson:function(){return JSON.stringify(this)}},I.prototype.intersects=function(a){if("Feature"===a.type&&(a=a.geometry),"LineString"===this.type){if("LineString"===a.type)return A(this.coordinates,a.coordinates);if("MultiLineString"===a.type)return B(this.coordinates,a.coordinates);if("Polygon"===a.type)return B(this.coordinates,G(a.coordinates));if("MultiPolygon"===a.type)return D(this.coordinates,a.coordinates)}else if("MultiLineString"===this.type){if("LineString"===a.type)return B(a.coordinates,this.coordinates);if("Polygon"===a.type||"MultiLineString"===a.type)return C(this.coordinates,a.coordinates);if("MultiPolygon"===a.type)return E(this.coordinates,a.coordinates)}else if("Polygon"===this.type){if("LineString"===a.type)return B(a.coordinates,G(this.coordinates));if("MultiLineString"===a.type)return C(G(this.coordinates),a.coordinates);if("Polygon"===a.type)return C(G(this.coordinates),G(a.coordinates));if("MultiPolygon"===a.type)return E(G(this.coordinates),a.coordinates)}else if("MultiPolygon"===this.type){if("LineString"===a.type)return D(a.coordinates,this.coordinates);if("Polygon"===a.type||"MultiLineString"===a.type)return E(G(a.coordinates),this.coordinates);if("MultiPolygon"===a.type)return F(this.coordinates,a.coordinates)}else if("Feature"===this.type){var c=new I(this.geometry);return c.intersects(a)}return b("Type "+this.type+" to "+a.type+" intersection is not supported by intersects"),!1},J.prototype=new I,J.prototype.constructor=J,K.prototype=new I,K.prototype.constructor=K,K.prototype.forEach=function(a){for(var b=0;b<this.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates]);return this},K.prototype.addPoint=function(a){return this.coordinates.push(a),this},K.prototype.insertPoint=function(a,b){return this.coordinates.splice(b,0,a),this},K.prototype.removePoint=function(a){return"number"==typeof a?this.coordinates.splice(a,1):this.coordinates.splice(this.coordinates.indexOf(a),1),this},K.prototype.get=function(a){return new J(this.coordinates[a])},L.prototype=new I,L.prototype.constructor=L,L.prototype.addVertex=function(a){return this.coordinates.push(a),this},L.prototype.insertVertex=function(a,b){return this.coordinates.splice(b,0,a),this},L.prototype.removeVertex=function(a){return this.coordinates.splice(a,1),this},M.prototype=new I,M.prototype.constructor=M,M.prototype.forEach=function(a){for(var b=0;b<this.coordinates.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates])},M.prototype.get=function(a){return new L(this.coordinates[a])},N.prototype=new I,N.prototype.constructor=N,N.prototype.addVertex=function(a){return this.coordinates[0].push(a),this},N.prototype.insertVertex=function(a,b){return this.coordinates[0].splice(b,0,a),this},N.prototype.removeVertex=function(a){return this.coordinates[0].splice(a,1),this},N.prototype.contains=function(a){if("Point"===a.type)return y(this.coordinates,a.coordinates);if("Polygon"===a.type){if(a.coordinates.length>0&&a.coordinates[0].length>0&&y(this.coordinates,a.coordinates[0][0])===!0&&this.intersects(a)===!1)return!0}else if("MultiPolygon"===a.type&&a.coordinates.length>0)for(var b=0;b<a.coordinates.length;b++)if(a.coordinates[b][0].length>0&&y(this.coordinates,a.coordinates[b][0][0])===!0&&this.intersects({type:"Polygon",coordinates:a.coordinates[b]})===!1)return!0;return!1},O.prototype=new I,O.prototype.constructor=O,O.prototype.forEach=function(a){for(var b=0;b<this.coordinates.length;b++)a.apply(this,[this.coordinates[b],b,this.coordinates])},O.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");for(var b=0;b<this.coordinates.length;b++)if(y(this.coordinates[b],a.coordinates))return!0;return!1},O.prototype.get=function(a){return new N(this.coordinates[a])},P.prototype=new I,P.prototype.constructor=P,P.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");if(!this.geometry.type.match(/Polygon/))throw new Error("Only features containing Polygons and MultiPolygons are supported");if("MultiPolygon"===this.geometry.type)for(var b=0;b<this.geometry.coordinates.length;b++)if(y(this.geometry.coordinates[b],a.coordinates))return!0;return"Polygon"===this.geometry.type?y(this.geometry.coordinates,a.coordinates):!1},Q.prototype=new I,Q.prototype.constructor=Q,Q.prototype.forEach=function(a){for(var b=0;b<this.features.length;b++)a.apply(this,[this.features[b],b,this.features])},Q.prototype.get=function(a){var b;return this.forEach(function(c){c.id===a&&(b=c)}),new P(b)},R.prototype=new I,R.prototype.constructor=R,R.prototype.forEach=function(a){for(var b=0;b<this.geometries.length;b++)a.apply(this,[this.geometries[b],b,this.geometries])},R.prototype.get=function(a){return new I(this.geometries[a])},T.prototype=new I,T.prototype.constructor=T,T.prototype.recalculate=function(){return this.geometry=S(this.center,this.radius,this.steps),this},T.prototype.contains=function(a){if("Point"!==a.type)throw new Error("Only points are supported");return y(this.geometry.coordinates,a.coordinates)},T.prototype.toJSON=function(){var a=I.prototype.toJSON.call(this);return a.properties.center=a.center,a.properties.steps=a.steps,a.properties.radius=a.radius,delete a.center,delete a.steps,delete a.radius,a},U.Primitive=I,U.Point=J,U.MultiPoint=K,U.LineString=L,U.MultiLineString=M,U.Polygon=N,U.MultiPolygon=O,U.Feature=P,U.FeatureCollection=Q,U.GeometryCollection=R,U.Circle=T,U.toMercator=q,U.toGeographic=r,U.Tools={},U.Tools.positionToMercator=o,U.Tools.positionToGeographic=n,U.Tools.applyConverter=p,U.Tools.toMercator=q,U.Tools.toGeographic=r,U.Tools.createCircle=S,U.Tools.calculateBounds=d,U.Tools.calculateEnvelope=j,U.Tools.coordinatesContainPoint=x,U.Tools.polygonContainsPoint=y,U.Tools.arrayIntersectsArray=A,U.Tools.coordinatesContainPoint=x,U.Tools.convexHull=w,U.MercatorCRS=Y,U.GeographicCRS=Z,U.Deferred=a,U}),function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.RTree=b().RTree}(this,function(){var Terraformer,a={};"object"==typeof this.navigator&&(Terraformer=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(Terraformer=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(Terraformer=arguments[0]);var b=function(a){var c=3,d=6;isNaN(a)||(c=Math.floor(a/2),d=a),this.min_width=c,this.max_width=d;var e={x:0,y:0,w:0,h:0,id:"root",nodes:[]};!function(){var a={};return function(b){var c=0;return b in a?c=a[b]++:a[b]=0,b+"_"+c}}(),b.Rectangle.squarified_ratio=function(a,b,c){var d=(a+b)/2,e=a*b,f=e/(d*d);return e*c/f};var f=function(a,d,e){var f=[],g=[],h=[],i=1;if(!a||!b.Rectangle.overlap_rectangle(a,e))return h;var j={x:a.x,y:a.y,w:a.w,h:a.h,target:d};g.push(e.nodes.length),f.push(e);do{var k=f.pop(),n=g.pop()-1;if("target"in j)for(;n>=0;){var o=k.nodes[n];if(b.Rectangle.overlap_rectangle(j,o)){if(j.target&&"leaf"in o&&o.leaf===j.target||!j.target&&("leaf"in o||b.Rectangle.contains_rectangle(o,j))){"nodes"in o?(h=l(o,!0,[],o),k.nodes.splice(n,1)):h=k.nodes.splice(n,1),b.Rectangle.make_MBR(k.nodes,k),delete j.target,k.nodes.length<c&&(j.nodes=l(k,!0,[],k));break}"nodes"in o&&(i+=1,g.push(n),f.push(k),k=o,n=o.nodes.length)}n-=1}else if("nodes"in j){k.nodes.splice(n+1,1),k.nodes.length>0&&b.Rectangle.make_MBR(k.nodes,k);for(var p=0;p<j.nodes.length;p++)m(j.nodes[p],k);j.nodes.length=0,0===f.length&&k.nodes.length<=1?(j.nodes=l(k,!0,j.nodes,k),k.nodes.length=0,f.push(k),g.push(1)):f.length>0&&k.nodes.length<c?(j.nodes=l(k,!0,j.nodes,k),k.nodes.length=0):delete j.nodes}else b.Rectangle.make_MBR(k.nodes,k);i-=1}while(f.length>0);return h},g=function(a,c){var d,e=-1,f=[];f.push(c);var g=c.nodes;do{-1!==e&&(f.push(g[e]),g=g[e].nodes,e=-1);for(var h=g.length-1;h>=0;h--){var i=g[h];if("leaf"in i){e=-1;break}var j=b.Rectangle.squarified_ratio(i.w,i.h,i.nodes.length+1),k=Math.max(i.x+i.w,a.x+a.w)-Math.min(i.x,a.x),l=Math.max(i.y+i.h,a.y+a.h)-Math.min(i.y,a.y),m=b.Rectangle.squarified_ratio(k,l,i.nodes.length+2);(0>e||Math.abs(m-j)<d)&&(d=Math.abs(m-j),e=h)}}while(-1!==e);return f},h=function(a){for(var b=j(a);a.length>0;)i(a,b[0],b[1]);return b},i=function(a,d,e){for(var f,g,h,i=b.Rectangle.squarified_ratio(d.w,d.h,d.nodes.length+1),j=b.Rectangle.squarified_ratio(e.w,e.h,e.nodes.length+1),k=a.length-1;k>=0;k--){var l=a[k],m={};m.x=Math.min(d.x,l.x),m.y=Math.min(d.y,l.y),m.w=Math.max(d.x+d.w,l.x+l.w)-m.x,m.h=Math.max(d.y+d.h,l.y+l.h)-m.y;var n=Math.abs(b.Rectangle.squarified_ratio(m.w,m.h,d.nodes.length+2)-i),o={};o.x=Math.min(e.x,l.x),o.y=Math.min(e.y,l.y),o.w=Math.max(e.x+e.w,l.x+l.w)-o.x,o.h=Math.max(e.y+e.h,l.y+l.h)-o.y;var p=Math.abs(b.Rectangle.squarified_ratio(o.w,o.h,e.nodes.length+2)-j);(!g||!f||Math.abs(p-n)<f)&&(g=k,f=Math.abs(p-n),h=n>p?e:d)}var q=a.splice(g,1)[0];d.nodes.length+a.length+1<=c?(d.nodes.push(q),b.Rectangle.expand_rectangle(d,q)):e.nodes.length+a.length+1<=c?(e.nodes.push(q),b.Rectangle.expand_rectangle(e,q)):(h.nodes.push(q),b.Rectangle.expand_rectangle(h,q))},j=function(a){for(var b,c,d=a.length-1,e=0,f=a.length-1,g=0,h=a.length-2;h>=0;h--){var i=a[h];i.x>a[e].x?e=h:i.x+i.w<a[d].x+a[d].w&&(d=h),i.y>a[g].y?g=h:i.y+i.h<a[f].y+a[f].h&&(f=h)}var j=Math.abs(a[d].x+a[d].w-a[e].x),k=Math.abs(a[f].y+a[f].h-a[g].y);return j>k?d>e?(b=a.splice(d,1)[0],c=a.splice(e,1)[0]):(c=a.splice(e,1)[0],b=a.splice(d,1)[0]):f>g?(b=a.splice(f,1)[0],c=a.splice(g,1)[0]):(c=a.splice(g,1)[0],b=a.splice(f,1)[0]),[{x:b.x,y:b.y,w:b.w,h:b.h,nodes:[b]},{x:c.x,y:c.y,w:c.w,h:c.h,nodes:[c]}]},k=function(a,b){return a.nodes=b.nodes,a.x=b.x,a.y=b.y,a.w=b.w,a.h=b.h,a},l=function(a,c,d,e){var f=[];if(!b.Rectangle.overlap_rectangle(a,e))return d;f.push(e.nodes);do for(var g=f.pop(),h=g.length-1;h>=0;h--){var i=g[h];b.Rectangle.overlap_rectangle(a,i)&&("nodes"in i?f.push(i.nodes):"leaf"in i&&(c?d.push(i):d.push(i.leaf)))}while(f.length>0);return d},m=function(a,c){var e;if(0===c.nodes.length)return c.x=a.x,c.y=a.y,c.w=a.w,c.h=a.h,c.nodes.push(a),void 0;var f=g(a,c),i=a;do{if(e&&"nodes"in e&&0===e.nodes.length){var j=e;e=f.pop();for(var k=0;k<e.nodes.length;k++)if(e.nodes[k]===j||0===e.nodes[k].nodes.length){e.nodes.splice(k,1);break}}else e=f.pop();if("leaf"in i||"nodes"in i||Array.isArray(i)){if(Array.isArray(i)){for(var l=0;l<i.length;l++)b.Rectangle.expand_rectangle(e,i[l]);e.nodes=e.nodes.concat(i)}else b.Rectangle.expand_rectangle(e,i),e.nodes.push(i);if(e.nodes.length<=d)i={x:e.x,y:e.y,w:e.w,h:e.h};else{var m=h(e.nodes);i=m,f.length<1&&(e.nodes.push(m[0]),f.push(e),i=m[1])}}else b.Rectangle.expand_rectangle(e,i),i={x:e.x,y:e.y,w:e.w,h:e.h}}while(f.length>0)};this.serialize=function(a){var b=new Terraformer.Deferred;return a&&b.then(function(b){a(null,b)},function(b){a(b,null)}),b.resolve(e),b},this.deserialize=function(a,b,c){var d=Array.prototype.slice.call(arguments),f=new Terraformer.Deferred;switch(d.length){case 1:b=e;break;case 2:"function"==typeof d[1]&&(b=e,c=d[1])}return c&&f.then(function(a){c(null,a)},function(a){c(a,null)}),f.resolve(k(b,a)),f},this.search=function(a,b){var c;if(a.type){var d=Terraformer.Tools.calculateBounds(a);c={x:d[0],y:d[1],w:Math.abs(d[0]-d[2]),h:Math.abs(d[1]-d[3])}}else c=a;var f=new Terraformer.Deferred,g=[c,!1,[],e];if(void 0===c)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";return b&&f.then(function(a){b(null,a)},function(a){b(a,null)}),f.resolve(l.apply(this,g)),f},this.remove=function(a,b,c){var d=Array.prototype.slice.call(arguments),g=new Terraformer.Deferred;if(1===d.length&&d.push(!1),3===d.length&&(c=d.pop(),g.then(function(a){c(null,a)},function(a){c(a,null)})),d[0].type){var h=Terraformer.Tools.calculateBounds(a);d[0]={x:h[0],y:h[1],w:Math.abs(h[0]-h[2]),h:Math.abs(h[1]-h[3])}}if(d.push(e),b===!1){var i=0,j=[];do i=j.length,j=j.concat(f.apply(this,d));while(i!==j.length);return j}return f.apply(this,d)},this.insert=function(a,b,c){var d;if(a.type){var f=Terraformer.Tools.calculateBounds(a);d={x:f[0],y:f[1],w:Math.abs(f[0]-f[2]),h:Math.abs(f[1]-f[3])}}else d=a;var g=new Terraformer.Deferred;if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle or GeoJSON and an object.";return c&&g.then(function(a){c(null,a)},function(a){c(a,null)}),g.resolve(m({x:d.x,y:d.y,w:d.w,h:d.h,leaf:b},e)),g}};return b.Rectangle=function(a,b,c,d){var e,f,g,h,i,j;a.x?(e=a.x,g=a.y,0!==a.w&&!a.w&&a.x2?(i=a.x2-a.x,j=a.y2-a.y):(i=a.w,j=a.h),f=e+i,h=g+j):(e=a,g=b,i=c,j=d,f=e+i,h=g+j),this.x1=this.x=function(){return e},this.y1=this.y=function(){return g},this.x2=function(){return f},this.y2=function(){return h},this.w=function(){return i},this.h=function(){return j},this.toJSON=function(){return'{"x":'+e.toString()+', "y":'+g.toString()+', "w":'+i.toString()+', "h":'+j.toString()+"}"},this.overlap=function(a){return this.x()<a.x2()&&this.x2()>a.x()&&this.y()<a.y2()&&this.y2()>a.y()},this.expand=function(a){var b=Math.min(this.x(),a.x()),c=Math.min(this.y(),a.y());return i=Math.max(this.x2(),a.x2())-b,j=Math.max(this.y2(),a.y2())-c,e=b,g=c,this},this.setRect=function(a,b,c,d){var e,f,g,h,i,j;a.x?(e=a.x,g=a.y,0!==a.w&&!a.w&&a.x2?(i=a.x2-a.x,j=a.y2-a.y):(i=a.w,j=a.h),f=e+i,h=g+j):(e=a,g=b,i=c,j=d,f=e+i,h=g+j)}},b.Rectangle.overlap_rectangle=function(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y},b.Rectangle.contains_rectangle=function(a,b){return a.x+a.w<=b.x+b.w&&a.x>=b.x&&a.y+a.h<=b.y+b.h&&a.y>=b.y},b.Rectangle.expand_rectangle=function(a,b){var c,d;return c=a.x<b.x?a.x:b.x,d=a.y<b.y?a.y:b.y,a.w=a.x+a.w>b.x+b.w?a.x+a.w-c:b.x+b.w-c,a.h=a.y+a.h>b.y+b.h?a.y+a.h-d:b.y+b.h-d,a.x=c,a.y=d,a},b.Rectangle.make_MBR=function(a,c){if(a.length<1)return{x:0,y:0,w:0,h:0};c?(c.x=a[0].x,c.y=a[0].y,c.w=a[0].w,c.h=a[0].h):c={x:a[0].x,y:a[0].y,w:a[0].w,h:a[0].h};for(var d=a.length-1;d>0;d--)b.Rectangle.expand_rectangle(c,a[d]);return c},a.RTree=b,a}),function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"object"==typeof a.navigator&&("undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.ArcGIS=b())}(this,function(){function a(a){for(var b,c=[],d=0;d<a.length;d++){b=a[d];for(var e=0;e<b.length;e++)c.push(b[e])}return c}function b(a,b){var c=Terraformer.Tools.arrayIntersectsArray(a,b),d=Terraformer.Tools.coordinatesContainPoint(a,b[0]);return!c&&d?!0:!1}function c(a){for(var c,d,e=[],f=0;f<a.length;f++){c=a[f];var g=[c],h=!1;for(d=0;d<a.length;d++){var i=a[d];c!==i&&b(i,c)&&(h=!0)}if(!h){for(d=0;d<a.length;d++){var j=a[d];c!==a[d]&&b(c,j)&&g.push(a[d])}e.push(g)}}return{type:"MultiPolygon",coordinates:e}}function d(a){var b={};a.x&&a.y&&(b.type="Point",b.coordinates=[a.x,a.y]),a.points&&(b.type="MultiPoint",b.coordinates=a.points),a.paths&&(1===a.paths.length?(b.type="LineString",b.coordinates=a.paths[0]):(b.type="MultiLineString",b.coordinates=a.paths)),a.rings&&(b=c(a.rings)),a.attributes&&a.geometry&&(b.type="Feature",b.geometry=d(a.geometry),b.properties=a.attributes);var e=a.geometry?a.geometry.spatialReference:a.spatialReference;return e&&102100===e.wkid&&(b=Terraformer.toGeographic(b)),new Terraformer.Primitive(b)}function e(b,c){var d,f=c?c:{wkid:4326},g={};switch(b.type){case"Point":g.x=b.coordinates[0],g.y=b.coordinates[1],g.spatialReference=f;break;case"MultiPoint":g.points=b.coordinates,g.spatialReference=f;break;case"LineString":g.paths=[b.coordinates],g.spatialReference=f;break;case"MultiLineString":g.paths=b.coordinates,g.spatialReference=f;break;case"Polygon":g.rings=b.coordinates,g.spatialReference=f;break;case"MultiPolygon":g.rings=a(b.coordinates),g.spatialReference=f;break;case"Feature":g.geometry=e(b.geometry),g.attributes=b.properties;break;case"FeatureCollection":for(g=[],d=0;d<b.features.length;d++)g.push(e(b.features[d]));break;case"GeometryCollection":for(g=[],d=0;d<b.geometries.length;d++)g.push(e(b.geometries[d]))}return g}var Terraformer,f={};return"object"==typeof this.navigator&&(Terraformer=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(Terraformer=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(Terraformer=arguments[0]),f.parse=d,f.convert=e,f}),L.esri={_callbacks:{},get:function(a,b,c){var d="callback_"+(1e9*Math.random()).toString(36);b.f="json",b.callback="L.esri._callbacks['"+d+"']";var e="?";for(var f in b)if(b.hasOwnProperty(f)){var g=f,h=b[f];e+=encodeURIComponent(g),e+="=",e+=encodeURIComponent(h),e+="&"}e=e.substring(0,e.length-1);var i=document.createElement("script");i.type="text/javascript",i.src=a+e,i.id=d,L.esri._callbacks[d]=function(a){c(a),document.body.removeChild(i),delete L.esri._callbacks[d]},document.body.appendChild(i)}},L.esri.Util={extentToBounds:function(a){var b=new L.LatLng(a.xmin,a.ymin),c=new L.LatLng(a.xmax,a.ymin);return new L.LatLngBounds(b,c)},boundsToExtent:function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},boundsToEnvelope:function(a){var b=L.esri.Util.boundsToExtent(a);return{x:b.xmin,y:b.ymin,w:Math.abs(b.xmin-b.ymax),h:Math.abs(b.ymin-b.ymax)}}},L.esri.Mixins={identifiableLayer:{identify:function(a,b){L.esri.get(this.serviceUrl+"/identify",{sr:"4265",mapExtent:JSON.stringify(L.esri.Util.boundsToExtent(this._map.getBounds())),tolerance:3,geometryType:"esriGeometryPoint",imageDisplay:"800,600,96",geometry:JSON.stringify({x:a.lng,y:a.lat,spatialReference:{wkid:4265}})},b)}}},L.esri.BasemapLayer=L.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Topographic:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Oceans:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},NationalGeographic:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Gray:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Copyright: &copy;2013 Esri, DeLorme, NAVTEQ</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},GrayLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}},Imagery:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},ImageryLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}}}},initialize:function(a,b){var c;if("object"==typeof a&&a.urlTemplate&&a.options)c=a;else{if("string"!=typeof a||!L.esri.BasemapLayer.TILES[a])throw new Error("L.esri.BasemapLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery' or 'ImageryLabels'");c=L.esri.BasemapLayer.TILES[a]}var d=L.Util.extend(c.options,b);L.TileLayer.prototype.initialize.call(this,c.urlTemplate,L.Util.setOptions(this,d)),c.attributionUrl&&(this.dynamicAttribution=!0,this.getAttributionData(c.attributionUrl))
},dynamicAttribution:!1,bounds:null,zoom:null,handleTileUpdates:function(a){var b,c;"load"===a.type&&(b=this._map.getBounds(),c=this._map.getZoom()),("viewreset"===a.type||"dragend"===a.type||"zoomend"===a.type)&&(b=a.target.getBounds(),c=a.target.getZoom()),this.attributionBoundingBoxes&&b&&c&&(b.equals(this.bounds)&&c===this.zoom||(this.bounds=b,this.zoom=c,this.updateMapAttribution()))},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a),this.dynamicAttribution&&(this.on("load",this.handleTileUpdates,this),this._map.on("viewreset zoomend dragend",this.handleTileUpdates,this)),this._map.on("resize",this.resizeAttribution,this)},resizeAttribution:function(){this.getAttributionSpan().style.maxWidth=.75*this._map.getSize().x-65+"px"},onRemove:function(a){this.dynamicAttribution&&(this.off("load",this.handleTileUpdates,this),this._map.off("viewreset zoomend dragend",this.handleTileUpdates,this)),this._map.off("resize",this.resizeAttribution,this),L.TileLayer.prototype.onRemove.call(this,a)},getAttributionData:function(a){this.attributionBoundingBoxes=[],L.esri.get(a,{},L.bind(this.processAttributionData,this))},processAttributionData:function(a){for(var b=0;b<a.contributors.length;b++)for(var c=a.contributors[b],d=0;d<c.coverageAreas.length;d++){var e=c.coverageAreas[d],f=new L.LatLng(e.bbox[0],e.bbox[1]),g=new L.LatLng(e.bbox[2],e.bbox[3]);this.attributionBoundingBoxes.push({attribution:c.attribution,score:e.score,bounds:new L.LatLngBounds(f,g),minZoom:e.zoomMin,maxZoom:e.zoomMax})}this.attributionBoundingBoxes.sort(function(a,b){return a.score<b.score?-1:a.score>b.score?1:0}),this.bounds&&this.updateMapAttribution()},getAttributionSpan:function(){return this._map._container.getElementsByClassName("esri-attributions")[0]},updateMapAttribution:function(){for(var a=[],b=0;b<this.attributionBoundingBoxes.length;b++){var c=this.attributionBoundingBoxes[b];if(this.bounds.intersects(c.bounds)&&this.zoom>=c.minZoom&&this.zoom<=c.maxZoom){var d=this.attributionBoundingBoxes[b].attribution;-1===a.indexOf(d)&&a.push(d)}}this.getAttributionSpan().innerHTML=a.join(", "),this.resizeAttribution()}}),L.esri.basemapLayer=function(a,b){return new L.esri.BasemapLayer(a,b)},L.esri.DynamicMapLayer=L.ImageOverlay.extend({includes:L.esri.Mixins.identifiableLayer,defaultParams:{format:"png8",transparent:!0,f:"image",bboxSR:102100,imageSR:102100,layers:"",opacity:1},initialize:function(a,b){"/"!==a[a.length-1]&&(a+="/"),this._url=a,this.serviceUrl=a,this._layerParams=L.Util.extend({},this.defaultParams);for(var c in b)this.options.hasOwnProperty(c)||(this._layerParams[c]=b[c]);delete this._layerParams.token,this._parseLayers(),this._parseLayerDefs(),L.Util.setOptions(this,b)},onAdd:function(a){if(this._map=a,this._image||this._initImage(),a._panes.overlayPane.appendChild(this._image),a.on({viewreset:this._reset,moveend:this._update,zoomend:this._zoomUpdate},this),a.options.zoomAnimation&&L.Browser.any3d&&a.on("zoomanim",this._animateZoom,this),a.options.crs&&a.options.crs.code){var b=a.options.crs.code.split(":")[1];this._layerParams.bboxSR=b,this._layerParams.imageSR=b}this._reset()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._image),a.off({viewreset:this._reset,moveend:this._update},this),a.options.zoomAnimation&&a.off("zoomanim",this._animateZoom,this)},_animateZoom:function(a){var b=this._map,c=this._image,d=b.getZoomScale(a.zoom),e=this._map.getBounds().getNorthWest(),f=this._map.getBounds().getSouthEast(),g=b._latLngToNewLayerPoint(e,a.zoom,a.center),h=b._latLngToNewLayerPoint(f,a.zoom,a.center)._subtract(g),i=g._add(h._multiplyBy(.5*(1-1/d)));c.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(i)+" scale("+d+") "},_parseLayers:function(){if("undefined"==typeof this._layerParams.layers)return delete this._layerParams.layerOption,void 0;var a=this._layerParams.layerOption||null,b=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];if(delete this._layerParams.layerOption,a)-1!==d.indexOf(a)&&(c=a),this._layerParams.layers=c+":"+b;else if(b instanceof Array)this._layerParams.layers=c+":"+b.join(",");else if("string"==typeof b){var e=b.match(":");e&&(b=b.split(e[0]),Number(b[1].split(",")[0])&&(-1!==d.indexOf(b[0])&&(c=b[0]),b=b[1])),this._layerParams.layers=c+":"+b}},_parseLayerDefs:function(){if("undefined"!=typeof this._layerParams.layerDefs){var a=this._layerParams.layerDefs,b=[];if(a instanceof Array)for(var c=a.length,d=0;c>d;d++)a[d]&&b.push(d+":"+a[d]);else{if("object"!=typeof a)return delete this._layerParams.layerDefs,void 0;for(var e in a)a.hasOwnProperty(e)&&b.push(e+":"+a[e])}this._layerParams.layerDefs=b.join(";")}},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this),src:this._getImageUrl()})},_getImageUrl:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._map.options.crs.project(a._northEast),d=this._map.options.crs.project(a._southWest);this._layerParams.bbox=[d.x,d.y,c.x,c.y].join(","),this._layerParams.size=b.x+","+b.y;var e=this._url+"export"+L.Util.getParamString(this._layerParams);return"undefined"!=typeof this.options.token&&(e=e+"&token="+this.options.token),e},_update:function(){if(!this._map._panTransition||!this._map._panTransition._inProgress){var a=this._map.getZoom();a>this.options.maxZoom||a<this.options.minZoom||(this._newImage=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._newImage,"leaflet-zoom-animated"):L.DomUtil.addClass(this._newImage,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._newImage,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onNewImageLoad,this),src:this._getImageUrl()}))}},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity),this._newImage&&L.DomUtil.setOpacity(this._newImage,this.options.opacity)},_zoomUpdate:function(){},_onNewImageLoad:function(){var a=this._map.getBounds(),b=L.latLng(a._northEast.lat,a._southWest.lng),c=L.latLng(a._southWest.lat,a._northEast.lng),d=this._map.latLngToLayerPoint(b),e=this._map.latLngToLayerPoint(c)._subtract(d);L.DomUtil.setPosition(this._newImage,d),this._newImage.style.width=e.x+"px",this._newImage.style.height=e.y+"px",this._map._panes.overlayPane.appendChild(this._newImage),this._map._panes.overlayPane.removeChild(this._image),this._image=this._newImage,this._newImage=null},_onImageLoad:function(){this.fire("load")},_reset:function(){}}),L.esri.dynamicMapLayer=function(a,b,c){return new L.esri.DynamicMapLayer(a,b,c)},L.esri.FeatureLayer=L.GeoJSON.extend({initialize:function(a,b){this.index=new Terraformer.RTree,"/"!==a[a.length-1]&&(a+="/"),this.url=a,L.GeoJSON.prototype.initialize.call(this,[],b)},onAdd:function(a){L.LayerGroup.prototype.onAdd.call(this,a),this.updateFeatures(a)},onRemove:function(a){L.LayerGroup.prototype.onRemove.call(this,a),a.off("viewreset moveend",L.Util.bind(this.updateFeatures,this))},updateFeatures:function(a){var b=L.Util.bind(function(){var b=a.getBounds(),c=L.esri.Util.boundsToEnvelope(b);this.index.search(c).then(L.Util.bind(function(a){this.eachLayer(L.Util.bind(function(b){var c=b.feature.id;this._toggleLayerVisibility(b,-1===a.indexOf(c))},this))},this)),L.esri.get(this.url+"query",{geometryType:"esriGeometryEnvelope",geometry:JSON.stringify(L.esri.Util.boundsToExtent(b)),outFields:"*",outSr:4326},L.Util.bind(function(a){if(a.objectIdFieldName&&a.features.length&&!a.error)for(var b=a.objectIdFieldName,c=a.features.length-1;c>=0;c--){var d=a.features[c],e=d.attributes[b];if(!this._layers[e]){var f=Terraformer.ArcGIS.parse(d);f.id=e,this.index.insert(f,e),this.addData(f)}}},this))},this),c=L.Util.bind(function(){clearTimeout(this._delay),this._delay=setTimeout(L.Util.bind(function(){b()},this),250)},this);a.on("viewreset moveend",c),b()},getLayerId:function(a){return a.feature.id},_toggleLayerVisibility:function(a,b){var c=b?"addClass":"removeClass";if(a._icon&&L.DomUtil[c](a._icon,"esri-leaflet-hidden-feature"),a._shadow&&L.DomUtil[c](a._shadow,"esri-leaflet-hidden-feature"),a._layers)for(var d in a._layers)a._layers.hasOwnProperty(d)&&L.DomUtil[c](a._layers[d]._container,"esri-leaflet-hidden-feature")}}),L.esri.featureLayer=function(a,b){return new L.esri.FeatureLayer(a,b)},L.esri.TiledMapLayer=L.TileLayer.extend({includes:L.esri.Mixins.identifiableLayer,initialize:function(a,b){b=b||{},"/"!==a[a.length-1]&&(a+="/"),this.serviceUrl=a,this.tileUrl=a+"tile/{z}/{y}/{x}",this.tileUrl.match("://tiles.arcgis.com")&&(this.tileUrl=this.tileUrl.replace("://tiles.arcgis.com","://tiles{s}.arcgis.com"),b.subdomains=["1","2","3","4"]),L.TileLayer.prototype.initialize.call(this,this.tileUrl,b)}}),L.esri.tiledMapLayer=function(a,b){return new L.esri.TiledMapLayer(a,b)};