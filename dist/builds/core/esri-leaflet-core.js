/*! Esri-Leaflet - v0.0.1-beta.5 - 2014-06-16
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri={VERSION:"0.0.1-beta.5",Layers:{},Services:{},Controls:{},Tasks:{},Util:{},Support:{CORS:!!(window.XMLHttpRequest&&"withCredentials"in new XMLHttpRequest),pointerEvents:""===document.documentElement.style.pointerEvents}},function(L){function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function b(a){return c(a[0],a[a.length-1])||a.push(a[0]),a}function c(a,b){for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function d(a){var b,c=0,d=0,e=a.length,f=a[d];for(d;e-1>d;d++)b=a[d+1],c+=(b[0]-f[0])*(b[1]+f[1]),f=b;return c>=0}function e(a,b,c,d){var e=(d[0]-c[0])*(a[1]-c[1])-(d[1]-c[1])*(a[0]-c[0]),f=(b[0]-a[0])*(a[1]-c[1])-(b[1]-a[1])*(a[0]-c[0]),g=(d[1]-c[1])*(b[0]-a[0])-(d[0]-c[0])*(b[1]-a[1]);if(0!==g){var h=e/g,i=f/g;if(h>=0&&1>=h&&i>=0&&1>=i)return!0}return!1}function f(a,b){for(var c=0;c<a.length-1;c++)for(var d=0;d<b.length-1;d++)if(e(a[c],a[c+1],b[d],b[d+1]))return!0;return!1}function g(a,b){for(var c=!1,d=-1,e=a.length,f=e-1;++d<e;f=d)(a[d][1]<=b[1]&&b[1]<a[f][1]||a[f][1]<=b[1]&&b[1]<a[d][1])&&b[0]<(a[f][0]-a[d][0])*(b[1]-a[d][1])/(a[f][1]-a[d][1])+a[d][0]&&(c=!c);return c}function h(a,b){var c=f(a,b),d=g(a,b[0]);return!c&&d?!0:!1}function i(a){for(var c=[],e=[],f=0;f<a.length;f++){var g=b(a[f].slice(0));if(!(g.length<4))if(d(g)){var i=[g];c.push(i)}else e.push(g)}for(;e.length;){for(var j=e.pop(),k=!1,l=c.length-1;l>=0;l--){var m=c[l][0];if(h(m,j)){c[l].push(j),k=!0;break}}k||c.push([j.reverse()])}return 1===c.length?{type:"Polygon",coordinates:c[0]}:{type:"MultiPolygon",coordinates:c}}function j(a){var c=[],e=a.slice(0),f=b(e.shift().slice(0));if(f.length>=4){d(f)||f.reverse(),c.push(f);for(var g=0;g<e.length;g++){var h=b(e[g].slice(0));h.length>=4&&(d(h)&&h.reverse(),c.push(h))}}return c}function k(a){for(var b=[],c=0;c<a.length;c++)for(var d=j(a[c]),e=d.length-1;e>=0;e--){var f=d[e].slice(0);b.push(f)}return b}L.esri.Util.extentToBounds=function(a){var b=new L.LatLng(a.ymin,a.xmin),c=new L.LatLng(a.ymax,a.xmax);return new L.LatLngBounds(b,c)},L.esri.Util.boundsToExtent=function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},L.esri.Util.arcgisToGeojson=function(b,c){var d={};return"number"==typeof b.x&&"number"==typeof b.y&&(d.type="Point",d.coordinates=[b.x,b.y]),b.points&&(d.type="MultiPoint",d.coordinates=b.points.slice(0)),b.paths&&(1===b.paths.length?(d.type="LineString",d.coordinates=b.paths[0].slice(0)):(d.type="MultiLineString",d.coordinates=b.paths.slice(0))),b.rings&&(d=i(b.rings.slice(0))),(b.geometry||b.attributes)&&(d.type="Feature",d.geometry=b.geometry?L.esri.Util.arcgisToGeojson(b.geometry):null,d.properties=b.attributes?a(b.attributes):null,b.attributes&&(d.id=b.attributes[c]||b.attributes.OBJECTID||b.attributes.FID)),d},L.esri.Util.geojsonToArcGIS=function(b,c){c=c||"OBJECTID";var d,e={wkid:4326},f={};switch(b.type){case"Point":f.x=b.coordinates[0],f.y=b.coordinates[1],f.spatialReference=e;break;case"MultiPoint":f.points=b.coordinates.slice(0),f.spatialReference=e;break;case"LineString":f.paths=[b.coordinates.slice(0)],f.spatialReference=e;break;case"MultiLineString":f.paths=b.coordinates.slice(0),f.spatialReference=e;break;case"Polygon":f.rings=j(b.coordinates.slice(0)),f.spatialReference=e;break;case"MultiPolygon":f.rings=k(b.coordinates.slice(0)),f.spatialReference=e;break;case"Feature":b.geometry&&(f.geometry=L.esri.Util.geojsonToArcGIS(b.geometry,c)),f.attributes=b.properties?a(b.properties):{},b.id&&(f.attributes[c]=b.id);break;case"FeatureCollection":for(f=[],d=0;d<b.features.length;d++)f.push(L.esri.Util.geojsonToArcGIS(b.features[d],c));break;case"GeometryCollection":for(f=[],d=0;d<b.geometries.length;d++)f.push(L.esri.Util.geojsonToArcGIS(b.geometries[d],c))}return f},L.esri.Util.responseToFeatureCollection=function(a,b){var c;if(b)c=b;else if(a.objectIdFieldName)c=a.objectIdFieldName;else if(a.fields){for(var d=0;d<=a.fields.length-1;d++)if("esriFieldTypeOID"===a.fields[d].type){c=a.fields[d].name;break}}else c="OBJECTID";var e={type:"FeatureCollection",features:[]},f=a.features||a.results;if(f.length)for(var g=f.length-1;g>=0;g--)e.features.push(L.esri.Util.arcgisToGeojson(f[g],c));return e},L.esri.Util.cleanUrl=function(a){return a=a.replace(/\s\s*/g,""),"/"!==a[a.length-1]&&(a+="/"),a}}(L),function(L){function a(a){var b="";a.f="json";for(var c in a)if(a.hasOwnProperty(c)){var d,e=a[c],f=Object.prototype.toString.call(e);b.length&&(b+="&"),d="[object Array]"===f||"[object Object]"===f?JSON.stringify(e):"[object Date]"===f?e.valueOf():e,b+=encodeURIComponent(c)+"="+encodeURIComponent(d)}return b}function b(a,b){var c=new XMLHttpRequest;return c.onerror=function(){a.call(b,{error:{code:500,message:"XMLHttpRequest error"}},null)},c.onreadystatechange=function(){var d,e;if(4===c.readyState){try{d=JSON.parse(c.responseText)}catch(f){d=null,e={code:500,message:"Could not parse response as JSON."}}!e&&d.error&&(e=d.error,d=null),a.call(b,e,d)}},c}var c=0;L.esri.Request={post:{XMLHTTP:function(c,d,e,f){var g=b(e,f);return g.open("POST",c),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.send(a(d)),g}},get:{CORS:function(c,d,e,f){var g=b(e,f);return g.open("GET",c+"?"+a(d),!0),g.send(null),g},JSONP:function(b,d,e,f){L.esri._callback=L.esri._callback||{};var g="c"+c;d.callback="L.esri._callback."+g;var h=L.DomUtil.create("script",null,document.body);return h.type="text/javascript",h.src=b+"?"+a(d),h.id=g,L.esri._callback[g]=function(a){if(L.esri._callback[g]!==!0){var b,c=Object.prototype.toString.call(a);"[object Object]"!==c&&"[object Array]"!==c&&(b={error:{code:500,message:"Expected array or object as JSONP response"}},a=null),!b&&a.error&&(b=a,a=null),e.call(f,b,a),L.esri._callback[g]=!0}},c++,L.esri._callback[g]}}},L.esri.get=L.esri.Support.CORS?L.esri.Request.get.CORS:L.esri.Request.get.JSONP,L.esri.post=L.esri.Request.post.XMLHTTP}(L),L.esri.Services.Service=L.Class.extend({includes:L.Mixin.Events,options:{proxy:!1,useCors:!0},initialize:function(a,b){this.url=L.esri.Util.cleanUrl(a),this._requestQueue=[],this._authenticating=!1,b=L.Util.setOptions(this,b)},get:function(a,b,c,d){return this._request("get",a,b,c,d)},post:function(a,b,c,d){return this._request("post",a,b,c,d)},metadata:function(a,b){return this._request("get","",{},a,b)},authenticate:function(a){return this._authenticating=!1,this.options.token=a,this._runQueue(),this},_request:function(a,b,c,d,e){this.fire("requeststart",{url:this.url+b,params:c,method:a});var f=this._createServiceCallback(a,b,c,d,e);if(this.options.token&&(c.token=this.options.token),!this._authenticating){var g=this.options.proxy?this.options.proxy+"?"+this.url+b:this.url+b;return"get"!==a||this.options.useCors?L.esri[a](g,c,f):L.esri.Request.get.JSONP(g,c,f)}this._requestQueue.push([a,b,c,d,e])},_createServiceCallback:function(a,b,c,d,e){var f=[a,b,c,d,e];return L.Util.bind(function(g,h){!g||499!==g.code&&498!==g.code?(d.call(e,g,h),g?this.fire("requesterror",{url:this.url+b,params:c,message:g.message,code:g.code,method:a}):this.fire("requestsuccess",{url:this.url+b,params:c,response:h,method:a}),this.fire("requestend",{url:this.url+b,params:c,method:a})):(this._authenticating=!0,this._requestQueue.push(f),this.fire("authenticationrequired",{authenticate:L.Util.bind(this.authenticate,this)}))},this)},_runQueue:function(){for(var a=this._requestQueue.length-1;a>=0;a--){var b=this._requestQueue[a],c=b.shift();this[c].apply(this,b)}this._requestQueue=[]}}),L.esri.Services.service=function(a,b){return new L.esri.Services.Service(a,b)};