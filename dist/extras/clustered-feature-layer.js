/*! Esri-Leaflet - v0.0.1-beta.4 - 2014-05-09
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri.ClusteredFeatureLayer=L.esri.FeatureManager.extend({statics:{EVENTS:"click dblclick mouseover mouseout mousemove contextmenu popupopen popupclose clusterclick clusterdblclick clustermouseover clustermouseout clustermousemove clustercontextmenu clusterpopupopen clusterpopupclose"},initialize:function(a,b){L.esri.FeatureManager.prototype.initialize.call(this,a,b),b=L.setOptions(this,b),this._layers={},this.cluster=new L.MarkerClusterGroup(b),this.cluster.on(L.esri.ClusteredFeatureLayer.EVENTS,this._propagateEvent,this)},onAdd:function(a){L.esri.FeatureManager.prototype.onAdd.call(this,a),this._map.addLayer(this.cluster)},onRemove:function(a){L.esri.FeatureManager.prototype.onRemove.call(this,a),this._map.removeLayer(this.cluster)},createLayers:function(a){for(var b=[],c=a.length-1;c>=0;c--){var d=a[c],e=this._layers[d.id];if(!e){var f=L.GeoJSON.geometryToLayer(d,this.options.pointToLayer,L.GeoJSON.coordsToLatLng,this.options);f.feature=L.GeoJSON.asFeature(d),f.defaultOptions=f.options,this.resetStyle(f),this._popup&&f.bindPopup(this._popup(f.feature,f)),this._layers[f.feature.id]=f,(!this._timeEnabled||this._timeEnabled&&this._featureWithinTimeRange(d))&&b.push(f)}}b.length&&this.cluster.addLayers(b)},addLayers:function(a){for(var b=[],c=a.length-1;c>=0;c--){var d=this._layers[a[c]];b.push(d)}this.cluster.addLayers(b)},removeLayers:function(a){for(var b=[],c=a.length-1;c>=0;c--){var d=this._layers[a[c]];b.push(d)}this.cluster.removeLayers(b)},resetStyle:function(a){a.options=a.defaultOptions,this._setLayerStyle(a,this.options.style)},setStyle:function(a){this.eachLayer(function(b){this._setLayerStyle(b,a)},this)},_setLayerStyle:function(a,b){"function"==typeof b&&(b=b(a.feature)),a.setStyle&&a.setStyle(b)},bindPopup:function(a,b){this._popup=a;for(var c in this._layers){var d=this._layers[c],e=this._popup(d.feature,d);d.bindPopup(e,b)}},unbindPopup:function(){this._popup=!1;for(var a in this._layers)this._layers[a].unbindPopup()},eachFeature:function(a,b){for(var c in this._layers)a.call(b,this._layers[c]);return this},getFeature:function(a){return this._layers[a]},_propagateEvent:function(a){a=L.extend({layer:a.target,target:this},a),this.fire(a.type,a)}}),L.esri.clusteredFeatureLayer=function(a){return new L.esri.ClusteredFeatureLayer(a)};