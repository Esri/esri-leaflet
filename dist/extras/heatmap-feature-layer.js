/*! Esri-Leaflet - v0.0.1-beta.4 - 2014-02-24
*   Copyright (c) 2014 Environmental Systems Research Institute, Inc.
*   Apache License*/
!function(L){L.esri.HeatMapFeatureLayer=L.Class.extend({includes:L.esri.Mixins.featureGrid,options:{cellSize:512,debounce:100,deduplicate:!0,where:"1=1",fields:["*"]},initialize:function(a,b){this.url=L.esri.Util.cleanUrl(a),L.Util.setOptions(this,b),this._getMetadata(),this._loaded=[],this.heat=new L.heatLayer([],this.options)},onAdd:function(a){this.heat.addTo(a),this._initializeFeatureGrid(a)},onRemove:function(a){a.removeLayer(this.heat),this._destroyFeatureGrid(a)},addTo:function(a){return a.addLayer(this),this},getWhere:function(){return this.options.where},setWhere:function(a){return this.options.where=a,this.refresh(),this},getFields:function(){return this.options.fields},setFields:function(a){return this.options.fields=a,this.refresh(),this},refresh:function(){this.heat._latlngs=[],this._loaded=[],this._previousCells=[],this._requestFeatures(this._map.getBounds())},_render:function(a){if(a.features&&a.features.length&&!a.error){var b=a.objectIdFieldName,c=[];if(!b)for(var d=0;d<=a.fields.length-1;d++)if("esriFieldTypeOID"===a.fields[d].type){b=a.fields[d].name;break}for(var e=a.features.length-1;e>=0;e--){var f=a.features[e],g=f.attributes[b];L.esri.Util.indexOf(this._loaded,g)<0&&(c.push(L.latLng([f.geometry.y,f.geometry.x])),this._loaded.push(g))}this.heat._latlngs=this.heat._latlngs.concat(c),this.heat.redraw()}}}),L.esri.HeatMapFeatureLayer.include(L.Mixin.Events),L.esri.HeatMapFeatureLayer.include(L.esri.Mixins.metadata),L.esri.heatMapFeatureLayer=function(a,b){return new L.esri.HeatMapFeatureLayer(a,b)}}(L);