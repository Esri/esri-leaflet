/*! Esri-Leaflet - v0.0.1 - 2013-06-14
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri===void 0&&(L.esri={}),L.esri.Util={extentToBounds:function(e){var t=new L.LatLng(e.xmin,e.ymin),r=new L.LatLng(e.xmax,e.ymin);return new L.LatLngBounds(t,r)},boundsToExtent:function(e){return{xmin:e.getSouthWest().lng,ymin:e.getSouthWest().lat,xmax:e.getNorthEast().lng,ymax:e.getNorthEast().lat,spatialReference:{wkid:4326}}},boundsToEnvelope:function(e){var t=L.esri.Util.boundsToExtent(e);return{x:t.xmin,y:t.ymin,w:Math.abs(t.xmin-t.ymax),h:Math.abs(t.ymin-t.ymax)}}},L.esri.FeatureLayer=L.GeoJSON.extend({initialize:function(e,t){this.index=new Terraformer.RTree,this._serviceUrl=e,this._layerCache={},this.client=new Esri.ArcGIS,this.service=new this.client.FeatureService({url:e}),L.GeoJSON.prototype.initialize.call(this,[],t)},onAdd:function(e){L.LayerGroup.prototype.onAdd.call(this,e),this.updateFeatures(e)},onRemove:function(e){this.eachLayer(e.removeLayer,e),e.off("viewreset moveend",L.Util.bind(this.updateFeatures,this))},updateFeatures:function(e){var t=L.Util.bind(function(){var t=e.getBounds(),r=L.esri.Util.boundsToEnvelope(t);this.index.search(r).then(L.Util.bind(function(t){this.eachLayer(L.Util.bind(function(r){var i=r.feature.id;-1===t.indexOf(i)?(this._layerCache[i]=this._layers[i],e.removeLayer(this._layers[i])):this._layerCache[i]&&this._layerCache[i].addTo(e)},this))},this)),this.service.query({geometryType:"esriGeometryEnvelope",geometry:JSON.stringify(L.esri.Util.boundsToExtent(t)),outSr:4326},L.Util.bind(function(e,t){for(var r=t.objectIdFieldName,i=t.features.length-1;i>=0;i--){var o=t.features[i],n=o.attributes[r];if(!this._layers[n]){var s=Terraformer.ArcGIS.parse(o);s.id=n,this.index.insert(s,n),this.addData(s)}}},this))},this),r=L.Util.bind(function(){clearTimeout(this._delay),this._delay=setTimeout(L.Util.bind(function(){t()},this),150)},this);e.on("viewreset moveend",r),t()},getLayerId:function(e){return e.feature.id}}),L.esri.featureLayer=function(e,t){return new L.esri.FeatureLayer(e,t)},L.esri===void 0&&(L.esri={}),L.esri.TileLayer=L.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Topographic:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Oceans:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},NationalGeographic:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Gray:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Copyright: &copy;2013 Esri, DeLorme, NAVTEQ</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},GrayLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}},Imagery:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},ImageryLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}}}},initialize:function(e,t){var r;if("object"==typeof e&&e.urlTemplate&&e.options)r=e;else{if("string"!=typeof e||!L.esri.TileLayer.TILES[e])throw Error("L.esri.TileLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery' or 'ImageryLabels'");r=L.esri.TileLayer.TILES[e]}var i=L.Util.extend(r.options,t);L.TileLayer.prototype.initialize.call(this,r.urlTemplate,L.Util.setOptions(this,i)),r.attributionUrl&&(this.dynamicAttribution=!0,this.getAttributionData(r.attributionUrl))},dynamicAttribution:!1,bounds:null,zoom:null,handleTileUpdates:function(e){var t,r;"load"===e.type&&(t=this._map.getBounds(),r=this._map.getZoom()),("viewreset"===e.type||"dragend"===e.type||"zoomend"===e.type)&&(t=e.target.getBounds(),r=e.target.getZoom()),this.attributionBoundingBoxes&&t&&r&&(t.equals(this.bounds)&&r===this.zoom||(this.bounds=t,this.zoom=r,this.updateMapAttribution()))},onAdd:function(e){L.TileLayer.prototype.onAdd.call(this,e),this.dynamicAttribution&&(this.on("load",this.handleTileUpdates),this._map.on("viewreset zoomend dragend",this.handleTileUpdates))},onRemove:function(e){this.dynamicAttribution&&(this.off("load",this.handleTileUpdates),this._map.off("viewreset zoomend dragend",this.handleTileUpdates)),L.TileLayer.prototype.onRemove.call(this,e)},getAttributionData:function(e){this.attributionBoundingBoxes=[];var t;window.XMLHttpRequest?t=new XMLHttpRequest:window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLHTTP")),t.onreadystatechange=L.bind(this.processAttributionData,this),t.open("GET",e,!0),t.send(null)},processAttributionData:function(e){if(4===e.target.readyState&&200===e.target.status){for(var t=JSON.parse(e.target.responseText),r=0;t.contributors.length>r;r++)for(var i=t.contributors[r],o=0;i.coverageAreas.length>o;o++){var n=i.coverageAreas[o],s=new L.LatLng(n.bbox[0],n.bbox[1]),a=new L.LatLng(n.bbox[2],n.bbox[3]);this.attributionBoundingBoxes.push({attribution:i.attribution,score:n.score,bounds:new L.LatLngBounds(s,a),minZoom:n.zoomMin,maxZoom:n.zoomMax})}this.attributionBoundingBoxes.sort(function(e,t){return e.score<t.score?-1:e.score>t.score?1:0}),this.bounds&&this.updateMapAttribution()}},updateMapAttribution:function(){for(var e=[],t=0;this.attributionBoundingBoxes.length>t;t++){var r=this.attributionBoundingBoxes[t];if(this.bounds.intersects(r.bounds)&&this.zoom>=r.minZoom&&this.zoom<=r.maxZoom){var i=this.attributionBoundingBoxes[t].attribution;-1===e.indexOf(i)&&e.push(i)}}this._map._container.getElementsByClassName("esri-attributions")[0].innerHTML=e.join(", ")}}),L.esri.tileLayer=function(e,t){return new L.esri.TileLayer(e,t)};