/*! Esri-Leaflet - v0.0.1 - 2013-06-18
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri.BasemapLayer=L.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Topographic:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Oceans:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},NationalGeographic:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Gray:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Copyright: &copy;2013 Esri, DeLorme, NAVTEQ</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},GrayLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}},Imagery:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},ImageryLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}}}},initialize:function(a,b){var c;if("object"==typeof a&&a.urlTemplate&&a.options)c=a;else{if("string"!=typeof a||!L.esri.BasemapLayer.TILES[a])throw new Error("L.esri.TileLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery' or 'ImageryLabels'");c=L.esri.BasemapLayer.TILES[a]}var d=L.Util.extend(c.options,b);L.TileLayer.prototype.initialize.call(this,c.urlTemplate,L.Util.setOptions(this,d)),c.attributionUrl&&(this.dynamicAttribution=!0,this.getAttributionData(c.attributionUrl))},dynamicAttribution:!1,bounds:null,zoom:null,handleTileUpdates:function(a){var b,c;"load"===a.type&&(b=this._map.getBounds(),c=this._map.getZoom()),("viewreset"===a.type||"dragend"===a.type||"zoomend"===a.type)&&(b=a.target.getBounds(),c=a.target.getZoom()),this.attributionBoundingBoxes&&b&&c&&(b.equals(this.bounds)&&c===this.zoom||(this.bounds=b,this.zoom=c,this.updateMapAttribution()))},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a),this.dynamicAttribution&&(this.on("load",this.handleTileUpdates),this._map.on("viewreset zoomend dragend",this.handleTileUpdates),this._map.on("resize",this.resizeAttribution))},resizeAttribution:function(){this.attributionSpan.style.maxWidth=.75*this._map.getSize().x-65+"px"},onRemove:function(a){this.dynamicAttribution&&(this.off("load",this.handleTileUpdates),this._map.off("viewreset zoomend dragend",this.handleTileUpdates),this._map.off("resize",this.resizeAttribution)),L.TileLayer.prototype.onRemove.call(this,a)},getAttributionData:function(a){this.attributionBoundingBoxes=[];var b;window.XMLHttpRequest?b=new XMLHttpRequest:window.ActiveXObject&&(b=new ActiveXObject("Microsoft.XMLHTTP")),b.onreadystatechange=L.bind(this.processAttributionData,this),b.open("GET",a,!0),b.send(null)},processAttributionData:function(a){if(4===a.target.readyState&&200===a.target.status){this.attributionIndex=new Terraformer.RTree;for(var b=JSON.parse(a.target.responseText),c=0;c<b.contributors.length;c++)for(var d=b.contributors[c],e=0;e<d.coverageAreas.length;e++){var f=d.coverageAreas[e],g=new L.LatLng(f.bbox[0],f.bbox[1]),h=new L.LatLng(f.bbox[2],f.bbox[3]),i=new L.LatLngBounds(g,h),j=L.esri.Util.boundsToEnvelope(i);this.attributionIndex.insert(j,{attribution:d.attribution,score:f.score,minZoom:f.zoomMin,maxZoom:f.zoomMax})}this.bounds&&this.updateMapAttribution()}},updateMapAttribution:function(){var a=[],b=L.esri.Util.boundsToEnvelope(this.bounds);this.attributionIndex&&this.attributionIndex.search(b).then(L.Util.bind(function(b){b.sort(function(a,b){return a.score<b.score?-1:a.score>b.score?1:0});for(var c=b.length-1;c>=0;c--){var d=b[c];this.zoom>=d.minZoom&&this.zoom<=d.maxZoom&&-1===a.indexOf(d.attribution)&&a.push(d.attribution)}this.attributionSpan=this._map._container.getElementsByClassName("esri-attributions")[0],this.attributionSpan.innerHTML=a.join(", "),this.resizeAttribution()},this))}}),L.esri.basemapLayer=function(a,b){return new L.esri.BasemapLayer(a,b)},L.esri.FeatureLayer=L.GeoJSON.extend({initialize:function(a,b){this.index=new Terraformer.RTree,this._serviceUrl=a,this._layerCache={},this.client=new Esri.ArcGIS,this.service=new this.client.FeatureService({url:a}),L.GeoJSON.prototype.initialize.call(this,[],b)},onAdd:function(a){L.LayerGroup.prototype.onAdd.call(this,a),this.updateFeatures(a)},onRemove:function(a){this.eachLayer(a.removeLayer,a),a.off("viewreset moveend",L.Util.bind(this.updateFeatures,this))},updateFeatures:function(a){var b=L.Util.bind(function(){var b=a.getBounds(),c=L.esri.Util.boundsToEnvelope(b);this.index.search(c).then(L.Util.bind(function(b){this.eachLayer(L.Util.bind(function(c){var d=c.feature.id;-1===b.indexOf(d)?(this._layerCache[d]=this._layers[d],a.removeLayer(this._layers[d])):this._layerCache[d]&&this._layerCache[d].addTo(a)},this))},this)),this.service.query({geometryType:"esriGeometryEnvelope",geometry:JSON.stringify(L.esri.Util.boundsToExtent(b)),outSr:4326},L.Util.bind(function(a,b){for(var c=b.objectIdFieldName,d=b.features.length-1;d>=0;d--){var e=b.features[d],f=e.attributes[c];if(!this._layers[f]){var g=Terraformer.ArcGIS.parse(e);g.id=f,this.index.insert(g,f),this.addData(g)}}},this))},this),c=L.Util.bind(function(){clearTimeout(this._delay),this._delay=setTimeout(L.Util.bind(function(){b()},this),150)},this);a.on("viewreset moveend",c),b()},getLayerId:function(a){return a.feature.id}}),L.esri.featureLayer=function(a,b){return new L.esri.FeatureLayer(a,b)},L.esri.TileLayer=L.TileLayer.extend({initialize:function(a,b){"/"!==a[-1]&&(a+="/");var c=a+"tile/{z}/{x}/{y}";L.TileLayer.prototype.initialize.call(this,c,b)}}),L.esri.tileLayer=function(a,b){return new L.esri.TileLayer(a,b)},L.esri={},L.esri.Util={extentToBounds:function(a){var b=new L.LatLng(a.xmin,a.ymin),c=new L.LatLng(a.xmax,a.ymin);return new L.LatLngBounds(b,c)},boundsToExtent:function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},boundsToEnvelope:function(a){var b=L.esri.Util.boundsToExtent(a);return{x:b.xmin,y:b.ymin,w:Math.abs(b.xmin-b.ymax),h:Math.abs(b.ymin-b.ymax)}}};