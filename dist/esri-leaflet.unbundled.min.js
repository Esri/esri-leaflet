/*! Esri-Leaflet - v0.0.1 - 2013-07-03
*   Copyright (c) 2013 Environmental Systems Research Institute, Inc.
*   Apache License*/
L.esri={_callbacks:{},get:function(a,b,c){var d="callback_"+(1e9*Math.random()).toString(36);b.f="json",b.callback="L.esri._callbacks['"+d+"']";var e="?";for(var f in b)if(b.hasOwnProperty(f)){var g=f,h=b[f];e+=encodeURIComponent(g),e+="=",e+=encodeURIComponent(h),e+="&"}e=e.substring(0,e.length-1);var i=document.createElement("script");i.type="text/javascript",i.src=a+e,i.id=d,L.esri._callbacks[d]=function(a){c(a),document.body.removeChild(i),delete L.esri._callbacks[d]},document.body.appendChild(i)}},L.esri.Util={extentToBounds:function(a){var b=new L.LatLng(a.xmin,a.ymin),c=new L.LatLng(a.xmax,a.ymin);return new L.LatLngBounds(b,c)},boundsToExtent:function(a){return{xmin:a.getSouthWest().lng,ymin:a.getSouthWest().lat,xmax:a.getNorthEast().lng,ymax:a.getNorthEast().lat,spatialReference:{wkid:4326}}},boundsToEnvelope:function(a){var b=L.esri.Util.boundsToExtent(a);return{x:b.xmin,y:b.ymin,w:Math.abs(b.xmin-b.ymax),h:Math.abs(b.ymin-b.ymax)}}},L.esri.Mixins={identifiableLayer:{identify:function(a,b){L.esri.get(this.serviceUrl+"/identify",{sr:"4265",mapExtent:JSON.stringify(L.esri.Util.boundsToExtent(this._map.getBounds())),tolerance:3,geometryType:"esriGeometryPoint",imageDisplay:"800,600,96",geometry:JSON.stringify({x:a.lng,y:a.lat,spatialReference:{wkid:4265}})},b)}}},L.esri.BasemapLayer=L.TileLayer.extend({statics:{TILES:{Streets:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Street_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Topographic:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/World_Topo_Map?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Oceans:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",attributionUrl:"http://static.arcgis.com/attribution/Ocean_Basemap?f=json",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},NationalGeographic:{urlTemplate:"http://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},Gray:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Copyright: &copy;2013 Esri, DeLorme, NAVTEQ</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},GrayLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}},Imagery:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19,attribution:"<span class='esri-attributions'>Esri, DigitalGlobe, GeoEye, i-cubed, USDA, USGS, AEX, Getmapping, Aerogrid, IGN, IGP, swisstopo, and the GIS User Community</span><img src='http://serverapi.arcgisonline.com/jsapi/arcgis/3.4/js/esri/images/map/logo-med.png' alt='Powered by Esri' class='esri-attribution-logo'>"}},ImageryLabels:{urlTemplate:"http://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",options:{minZoom:1,maxZoom:19}}}},initialize:function(a,b){var c;if("object"==typeof a&&a.urlTemplate&&a.options)c=a;else{if("string"!=typeof a||!L.esri.BasemapLayer.TILES[a])throw new Error("L.esri.BasemapLayer: Invalid parameter. Use one of 'Streets', 'Topographic', 'Oceans', 'NationalGeographic', 'Gray', 'GrayLabels', 'Imagery' or 'ImageryLabels'");c=L.esri.BasemapLayer.TILES[a]}var d=L.Util.extend(c.options,b);L.TileLayer.prototype.initialize.call(this,c.urlTemplate,L.Util.setOptions(this,d)),c.attributionUrl&&(this.dynamicAttribution=!0,this.getAttributionData(c.attributionUrl))},dynamicAttribution:!1,bounds:null,zoom:null,handleTileUpdates:function(a){var b,c;"load"===a.type&&(b=this._map.getBounds(),c=this._map.getZoom()),("viewreset"===a.type||"dragend"===a.type||"zoomend"===a.type)&&(b=a.target.getBounds(),c=a.target.getZoom()),this.attributionBoundingBoxes&&b&&c&&(b.equals(this.bounds)&&c===this.zoom||(this.bounds=b,this.zoom=c,this.updateMapAttribution()))},onAdd:function(a){L.TileLayer.prototype.onAdd.call(this,a),this.dynamicAttribution&&(this.on("load",this.handleTileUpdates,this),this._map.on("viewreset zoomend dragend",this.handleTileUpdates,this)),this._map.on("resize",this.resizeAttribution,this)},resizeAttribution:function(){this.getAttributionSpan().style.maxWidth=.75*this._map.getSize().x-65+"px"},onRemove:function(a){this.dynamicAttribution&&(this.off("load",this.handleTileUpdates,this),this._map.off("viewreset zoomend dragend",this.handleTileUpdates,this)),this._map.off("resize",this.resizeAttribution,this),L.TileLayer.prototype.onRemove.call(this,a)},getAttributionData:function(a){this.attributionBoundingBoxes=[],L.esri.get(a,{},L.bind(this.processAttributionData,this))},processAttributionData:function(a){for(var b=0;b<a.contributors.length;b++)for(var c=a.contributors[b],d=0;d<c.coverageAreas.length;d++){var e=c.coverageAreas[d],f=new L.LatLng(e.bbox[0],e.bbox[1]),g=new L.LatLng(e.bbox[2],e.bbox[3]);this.attributionBoundingBoxes.push({attribution:c.attribution,score:e.score,bounds:new L.LatLngBounds(f,g),minZoom:e.zoomMin,maxZoom:e.zoomMax})}this.attributionBoundingBoxes.sort(function(a,b){return a.score<b.score?-1:a.score>b.score?1:0}),this.bounds&&this.updateMapAttribution()},getAttributionSpan:function(){return this._map._container.getElementsByClassName("esri-attributions")[0]},updateMapAttribution:function(){for(var a=[],b=0;b<this.attributionBoundingBoxes.length;b++){var c=this.attributionBoundingBoxes[b];if(this.bounds.intersects(c.bounds)&&this.zoom>=c.minZoom&&this.zoom<=c.maxZoom){var d=this.attributionBoundingBoxes[b].attribution;-1===a.indexOf(d)&&a.push(d)}}this.getAttributionSpan().innerHTML=a.join(", "),this.resizeAttribution()}}),L.esri.basemapLayer=function(a,b){return new L.esri.BasemapLayer(a,b)},L.esri.FeatureLayer=L.GeoJSON.extend({initialize:function(a,b){this.index=new Terraformer.RTree,"/"!==a[a.length-1]&&(a+="/"),this.url=a,L.GeoJSON.prototype.initialize.call(this,[],b)},onAdd:function(a){L.LayerGroup.prototype.onAdd.call(this,a),this.updateFeatures(a)},onRemove:function(a){L.LayerGroup.prototype.onRemove.call(this,a),a.off("viewreset moveend",L.Util.bind(this.updateFeatures,this))},updateFeatures:function(a){var b=L.Util.bind(function(){var b=a.getBounds(),c=L.esri.Util.boundsToEnvelope(b);this.index.search(c).then(L.Util.bind(function(a){this.eachLayer(L.Util.bind(function(b){var c=b.feature.id;this._toggleLayerVisibility(b,-1===a.indexOf(c))},this))},this)),L.esri.get(this.url+"query",{geometryType:"esriGeometryEnvelope",geometry:JSON.stringify(L.esri.Util.boundsToExtent(b)),outFields:"*",outSr:4326},L.Util.bind(function(a){if(a.objectIdFieldName&&a.features.length&&!a.error)for(var b=a.objectIdFieldName,c=a.features.length-1;c>=0;c--){var d=a.features[c],e=d.attributes[b];if(!this._layers[e]){var f=Terraformer.ArcGIS.parse(d);f.id=e,this.index.insert(f,e),this.addData(f)}}},this))},this),c=L.Util.bind(function(){clearTimeout(this._delay),this._delay=setTimeout(L.Util.bind(function(){b()},this),250)},this);a.on("viewreset moveend",c),b()},getLayerId:function(a){return a.feature.id},_toggleLayerVisibility:function(a,b){var c=b?"addClass":"removeClass";if(a._icon&&L.DomUtil[c](a._icon,"esri-leaflet-hidden-feature"),a._shadow&&L.DomUtil[c](a._shadow,"esri-leaflet-hidden-feature"),a._layers)for(var d in a._layers)a._layers.hasOwnProperty(d)&&L.DomUtil[c](a._layers[d]._container,"esri-leaflet-hidden-feature")}}),L.esri.featureLayer=function(a,b){return new L.esri.FeatureLayer(a,b)},L.esri.TiledMapLayer=L.TileLayer.extend({includes:L.esri.Mixins.identifiableLayer,initialize:function(a,b){b=b||{},"/"!==a[a.length-1]&&(a+="/"),this.serviceUrl=a,this.tileUrl=a+"tile/{z}/{y}/{x}",this.tileUrl.match("://tiles.arcgis.com")&&(this.tileUrl=this.tileUrl.replace("://tiles.arcgis.com","://tiles{s}.arcgis.com"),b.subdomains=["1","2","3","4"]),L.TileLayer.prototype.initialize.call(this,this.tileUrl,b)}}),L.esri.tiledMapLayer=function(a,b){return new L.esri.TiledMapLayer(a,b)},/*!
 * The MIT License (MIT)
 *
 * Copyright (c) 2013 Sanborn Map Company, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
L.esri.DynamicMapLayer=L.ImageOverlay.extend({includes:L.esri.Mixins.identifiableLayer,defaultParams:{format:"png8",transparent:!0,f:"image",bboxSR:102100,imageSR:102100,layers:"",opacity:1},initialize:function(a,b){"/"!==a[a.length-1]&&(a+="/"),this._url=a,this.serviceUrl=a,this._layerParams=L.Util.extend({},this.defaultParams);for(var c in b)this.options.hasOwnProperty(c)||(this._layerParams[c]=b[c]);delete this._layerParams.token,this._parseLayers(),this._parseLayerDefs(),L.Util.setOptions(this,b)},onAdd:function(a){if(this._map=a,this._image||this._initImage(),a._panes.overlayPane.appendChild(this._image),a.on({viewreset:this._reset,moveend:this._update,zoomend:this._zoomUpdate},this),a.options.zoomAnimation&&L.Browser.any3d&&a.on("zoomanim",this._animateZoom,this),a.options.crs&&a.options.crs.code){var b=a.options.crs.code.split(":")[1];this._layerParams.bboxSR=b,this._layerParams.imageSR=b}this._reset()},onRemove:function(a){a.getPanes().overlayPane.removeChild(this._image),a.off({viewreset:this._reset,moveend:this._update},this),a.options.zoomAnimation&&a.off("zoomanim",this._animateZoom,this)},_animateZoom:function(a){var b=this._map,c=this._image,d=b.getZoomScale(a.zoom),e=this._map.getBounds().getNorthWest(),f=this._map.getBounds().getSouthEast(),g=b._latLngToNewLayerPoint(e,a.zoom,a.center),h=b._latLngToNewLayerPoint(f,a.zoom,a.center)._subtract(g),i=g._add(h._multiplyBy(.5*(1-1/d)));c.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(i)+" scale("+d+") "},_parseLayers:function(){if("undefined"==typeof this._layerParams.layers)return delete this._layerParams.layerOption,void 0;var a=this._layerParams.layerOption||null,b=this._layerParams.layers||null,c="show",d=["show","hide","include","exclude"];if(delete this._layerParams.layerOption,a)-1!==d.indexOf(a)&&(c=a),this._layerParams.layers=c+":"+b;else if(b instanceof Array)this._layerParams.layers=c+":"+b.join(",");else if("string"==typeof b){var e=b.match(":");e&&(b=b.split(e[0]),Number(b[1].split(",")[0])&&(-1!==d.indexOf(b[0])&&(c=b[0]),b=b[1])),this._layerParams.layers=c+":"+b}},_parseLayerDefs:function(){if("undefined"!=typeof this._layerParams.layerDefs){var a=this._layerParams.layerDefs,b=[];if(a instanceof Array)for(var c=a.length,d=0;c>d;d++)a[d]&&b.push(d+":"+a[d]);else{if("object"!=typeof a)return delete this._layerParams.layerDefs,void 0;for(var e in a)a.hasOwnProperty(e)&&b.push(e+":"+a[e])}this._layerParams.layerDefs=b.join(";")}},_initImage:function(){this._image=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._image,"leaflet-zoom-animated"):L.DomUtil.addClass(this._image,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._image,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onImageLoad,this),src:this._getImageUrl()})},_getImageUrl:function(){var a=this._map.getBounds(),b=this._map.getSize(),c=this._map.options.crs.project(a._northEast),d=this._map.options.crs.project(a._southWest);this._layerParams.bbox=[d.x,d.y,c.x,c.y].join(","),this._layerParams.size=b.x+","+b.y;var e=this._url+"export"+L.Util.getParamString(this._layerParams);return"undefined"!=typeof this.options.token&&(e=e+"&token="+this.options.token),e},_update:function(){if(!this._map._panTransition||!this._map._panTransition._inProgress){var a=this._map.getZoom();a>this.options.maxZoom||a<this.options.minZoom||(this._newImage=L.DomUtil.create("img","leaflet-image-layer"),this._map.options.zoomAnimation&&L.Browser.any3d?L.DomUtil.addClass(this._newImage,"leaflet-zoom-animated"):L.DomUtil.addClass(this._newImage,"leaflet-zoom-hide"),this._updateOpacity(),L.Util.extend(this._newImage,{galleryimg:"no",onselectstart:L.Util.falseFn,onmousemove:L.Util.falseFn,onload:L.Util.bind(this._onNewImageLoad,this),src:this._getImageUrl()}))}},_updateOpacity:function(){L.DomUtil.setOpacity(this._image,this.options.opacity),this._newImage&&L.DomUtil.setOpacity(this._newImage,this.options.opacity)},_zoomUpdate:function(){},_onNewImageLoad:function(){var a=this._map.getBounds(),b=L.latLng(a._northEast.lat,a._southWest.lng),c=L.latLng(a._southWest.lat,a._northEast.lng),d=this._map.latLngToLayerPoint(b),e=this._map.latLngToLayerPoint(c)._subtract(d);L.DomUtil.setPosition(this._newImage,d),this._newImage.style.width=e.x+"px",this._newImage.style.height=e.y+"px",this._map._panes.overlayPane.appendChild(this._newImage),this._map._panes.overlayPane.removeChild(this._image),this._image=this._newImage,this._newImage=null},_onImageLoad:function(){this.fire("load")},_reset:function(){}}),L.esri.dynamicMapLayer=function(a,b){return new L.esri.DynamicMapLayer(a,b)};